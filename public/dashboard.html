<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.1/css/all.min.css" integrity="sha512-5Hs3dF2AEPkpNAR7UiOHba+lRSJNeM2ECkwxUIxC1Q/FLycGTbNapWXB4tP889k5T5Ju8fs4b1P5z/iB4nMfSQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="dashboard.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg bg-dark text-white" >
        <div class="container-fluid">
            <a class="navbar-brand logo text-primary" href="#">DIGITAL LIBRARY</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" 
                    aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon" style="background-image: url('data:image/svg+xml;charset=UTF8,<svg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 30 30%27 fill=%27white%27><path stroke=%27rgba(255, 255, 255, 1)%27 stroke-width=%272%27 stroke-linecap=%27round%27 stroke-miterlimit=%2710%27 d=%27M4 7h22M4 15h22M4 23h22%27/></svg>');"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link text-white" aria-current="page" href="http://localhost:3000/home">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="http://localhost:3000/about">About</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="http://localhost:3000/contact">Contact</a>
                    </li>
                    
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle text-white" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Browse
                        </a>
                        <ul class="dropdown-menu">
                       
                            <li><a class="dropdown-item" href="http://localhost:3000/trending">Trending</a></li>
                            <li><a class="dropdown-item" href="http://localhost:3000/random">Random</a></li>
                            
                        </ul>
                    </li>
                </ul>
                
    
                    <button class="btn btn-outline-primary" type="submit"><a href="http://localhost:3000/search" id="search-btn">Search</a></button>
                    <button class="btn btn-outline-primary" id="logout" type="submit">Logout</button>
               
            </div>
        </div>
    </nav>
   <div class="main-container">
 
   <div class="main">
    <div class="banner">
        Admin DashBoard
    </div>
    <div class="parent1">
        <div class="parent2">
            <div class="div1">
                <h1>All Books</h1>
                <hr>
                <form action="">
                <input type="text" id="title" placeholder="Book title">
                <input type="text" id="name" placeholder="Author name">
                <select  id="Genre">
                    <option value="select a Genere">select a Genere</option>
                    <option value="Programming & Software Developement">Programming & Software Developement</option>
                    <option value="Data Science and Analytics">Data Science and Analytics</option>
                    <option value="Cybersecurity">Cybersecurity</option>
                    <option value="Cloude Computing">Cloude Computing</option>
                    <option value="Networking & Telecommunication">Networking & Telecommunication</option>
                    <option value="Novel">Novel</option>
                </select>
                <select id="select-option1">
                    <option value="All">All</option>
                    <option value="Title">Title</option>
                    <option value="Author">Author</option>
                    <option value="Genre">Genre</option>
                </select>
            
                <button id="searchBtn">Search</button>
                </form>


                <hr>

                <div class="grid-parent">
                    <div class="parent1">
                        <!-- Display Books -->
                       
                      </div>

                    


                </div>

            </div>
            <div class="div2">
                <h1>Add A Book</h1>
                <hr>
                <form id="add-book-form" enctype="multipart/form-data">
                    <input type="text" placeholder="Book Title">
                    <input type="text" placeholder="Author Name">
                    <select id="Genre">
                      <option value="select a Genere">select a Genere</option>
                      <option value="Programming & Software Development">Programming & Software Development</option>
                      <option value="Data Science and Analytics">Data Science and Analytics</option>
                      <option value="Cybersecurity">Cybersecurity</option>
                      <option value="Cloud Computing">Cloud Computing</option>
                      <option value="Networking & Telecommunication">Networking & Telecommunication</option>
                      <option value="Novel">Novel</option>
                    </select>
                    <input type="text" placeholder="Available No. of Copies">
                    <label for="location">Location:</label>
                    <br>
                    <input type="text" placeholder="Rack No.">
                    <input type="text" placeholder="Shelf No.">
                    
                   
                    <br>
                    <label for="img-insert">Insert the book Image:</label>
                    <input type="file">
                    <br>
                    <label for="pdf-insert">Insert the Book PDF:</label>
                    <input type="file" accept=".pdf"> 
                    <button type="submit"> Add Book </button>
                  </form>
                  <h4 style="text-align: center;" class="return-hed">Return A Book</h4>
                  <hr>
                  <p class="note-return" style="text-align: center;">Only Admin allow to return a Book of Specific Student.
                    When the Student return borrowed book to Library Office.
                </p>
                <style>
                 .return-hed{
                    margin-top: 20px;
                 }
                .return-btn a{
                    
               text-decoration: none;
               color: #fff;

                }
                 .return-btn {
                    
                    width: 330px;
                 height: 30px;
                 border: 0;
                   outline:0;
               margin-top: 10px;
            background-color: rgb(68, 68, 241);
              color: #fff;
              cursor: pointer;

                 }
                </style>


                  <button type="submit"  class="return-btn"><a href="#" id="open-modal" style="text-align: center;" style="font-size: 18px;">Return a Book</a></button>

                 <!-- Modal Container -->
<div id="modal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <div class="return-container">
            <h2>Return Book</h2>
            <form id="return-form">
                <label for="student-name">Student Username:</label>
                <input type="text" id="student-name" placeholder="Enter Student Name" required />

                <label for="book-title">Book Title:</label>
                <input type="text" id="book-title" placeholder="Enter Book Title" required />

                <label for="return-date">Return Date:</label>
                <input type="date" id="return-date" required />

                <button type="submit">Return Book</button>
            </form>
            <p class="note">Note: Late returns may incur a fine. Please ensure the book is returned in good condition.</p>
        </div>
    </div>
</div>

                  
                  <form id="update-book-form" >
                    <h3>Update A Book</h3>
                    <hr>
                    <input type="hidden" id="update-id"> 
                    <input type="text" id="update-title" placeholder="Book Title">
                    <input type="text" id="update-author" placeholder="Author Name">
                    <select id="update-genre">
                      <option value="select a Genere">select a Genere</option>
                      <option value="Programming & Software Development">Programming & Software Development</option>
                      <option value="Data Science and Analytics">Data Science and Analytics</option>
                      <option value="Cybersecurity">Cybersecurity</option>
                      <option value="Cloud Computing">Cloud Computing</option>
                      <option value="Networking & Telecommunication">Networking & Telecommunication</option>
                      <option value="Novel">Novel</option>
                    </select>
                    <input type="text" id="update-copies" placeholder="Available No. of Copies">
                    <input type="text" id="update-rack" placeholder="Rack No.">
                    <input type="text" id="update-shelf" placeholder="Shelf No.">
                   
                    <label for="update-image">Insert the book Image:</label>
                    <input type="file" id="update-image">
                    <img id="update-image-preview" src="default-book.png" alt="Current image preview" width="100">
                    <br>
                    <label for="update-pdf">Insert the book PDF:</label>
                    <input type="file" id="update-pdf" accept="application/pdf">
                    <br>
                    <button type="submit">Update Book</button>
                  </form> 




              
              
          


            </div>
        </div>



    

    


    </div>

<div class="space">

</div>



   </div>

  
 



 


<script>
document.addEventListener('DOMContentLoaded', () => {
  // Render books from the database
  fetchBooks();

  // Add book form
  document.querySelector('#add-book-form').addEventListener('submit', addBook);

  // Update book form
  document.querySelector('#update-book-form').addEventListener('submit', updateBook);
  document.querySelector('#searchBtn').addEventListener('click', searchBooks);
});

// Fetch all books from the server
function fetchBooks() {
  fetch('/api/books')
    .then(response => response.json())
    .then(books => {
      const gridParent = document.querySelector('.grid-parent');
      gridParent.innerHTML = ''; // Clear existing books
      books.forEach(book => {
        createBookBox(book);
      });
    })
    .catch(err => console.error('Error fetching books:', err));
}

// Create book box
function createBookBox(book) {
  const bookContainer = document.createElement('div');
  bookContainer.classList.add('con1');
  bookContainer.dataset.id = book.id;

  bookContainer.innerHTML = `
    <div class="img">
      <img src="${book.image}" alt="Book Cover">
    </div>
    <div class="book-details">
      <h6>Book Title: <span>${book.title}</span></h6>
      <p>Author: <span>${book.author}</span></p>
      <h6>Availability: <span>${book.copies}</span></h6>
      <h6>Genre: <span>${book.genre}</span></h6>
      <h6>Location: <span>Rack ${book.rack}, Shelf ${book.shelf}</span></h6>
      <h6>PDF: <a href="${book.pdf}" target="_blank">Download</a></h6>
      <form>
        <button type="button" class="update-btn" data-id="${book.id}">Update</button>
        <button type="button" class="remove-btn" style="background-color: red;" data-id="${book.id}">Remove</button>
      </form>
    </div>
  `;

  // Add event listeners for update and remove buttons
  bookContainer.querySelector('.update-btn').addEventListener('click', () => openUpdateForm(book.id));
  bookContainer.querySelector('.remove-btn').addEventListener('click', () => deleteBook(book.id));

  document.querySelector('.grid-parent').appendChild(bookContainer);
}

// Open the update form with the existing book details

document.getElementById("logout").addEventListener("click", () => {
    fetch('/logout', {
        method: 'POST',
        credentials: 'include' // Include cookies for session handling
    })
    .then((response) => {
        if (response.ok) {
            // Redirect to login page
            window.location.href = '/login';
        } else {
            return response.json().then((data) => {
                throw new Error(data.message || "Logout failed.");
            });
        }
    })
    .catch((error) => {
        console.error("Error during logout:", error);
        alert("An error occurred while logging out. Please try again.");
    });
});

// Handle add book
function addBook(event) {
  event.preventDefault();
  
  const title = document.querySelector('.div2 input[placeholder="Book Title"]').value;
  const author = document.querySelector('.div2 input[placeholder="Author Name"]').value;
  const genre = document.querySelector('.div2 #Genre').value;
  const copies = document.querySelector('.div2 input[placeholder="Available No. of Copies"]').value;
  const rack = document.querySelector('.div2 input[placeholder="Rack No."]').value;
  const shelf = document.querySelector('.div2 input[placeholder="Shelf No."]').value;
  const imageInput = document.querySelector('.div2 input[type="file"]');
  const pdfInput = document.querySelector('.div2 input[type="file"][accept=".pdf"]');

  if (!title || !author || !genre || !copies || !rack || !shelf) {
    alert('Please fill in all the required fields.');
    return;
  }

  const formData = new FormData();
  formData.append('title', title);
  formData.append('author', author);
  formData.append('genre', genre);
  formData.append('copies', copies);
  formData.append('rack', rack);
  formData.append('shelf', shelf);
  if (imageInput.files.length) formData.append('image', imageInput.files[0]);
  if (pdfInput.files.length) formData.append('pdf', pdfInput.files[0]);

  fetch('/api/books', {
    method: 'POST',
    body: formData
  })
    .then(response => {
      if (response.ok) {
        return response.text();
      } else {
        throw new Error('Failed to add the book.');
      }
    })
    .then(() => {
      alert('Book added successfully!');
      fetchBooks();
      document.querySelector('#add-book-form').reset();
    })
    .catch(err => {
      console.error('Error adding book:', err);
      alert('Failed to add the book. Please try again.');
    });
}
// Handle book update
function openUpdateForm(bookId) {
    fetch(`/api/books/${bookId}?t=${Date.now()}`, {
        headers: {
            'Cache-Control': 'no-cache'
        }
    })
        .then(response => response.json())
        .then(book => {
            const updateForm = document.querySelector('#update-book-form');
            updateForm.querySelector('#update-id').value = book.id;
            updateForm.querySelector('#update-title').value = book.title;
            updateForm.querySelector('#update-author').value = book.author;
            updateForm.querySelector('#update-genre').value = book.genre;
            updateForm.querySelector('#update-copies').value = book.copies;
            updateForm.querySelector('#update-rack').value = book.rack;
            updateForm.querySelector('#update-shelf').value = book.shelf;
            updateForm.querySelector('#update-image-preview').src = book.image || 'default-book.png';
            updateForm.style.display = 'block';
        })
        .catch(err => {
            console.error('Error fetching book details:', err);
            alert('Failed to fetch book details for updating');
        });
}
function updateBook(event) {
    event.preventDefault();

    const bookId = document.querySelector('#update-id').value;
    const title = document.querySelector('#update-title').value;
    const author = document.querySelector('#update-author').value;
    const genre = document.querySelector('#update-genre').value;
    const copies = document.querySelector('#update-copies').value;
    const rack = document.querySelector('#update-rack').value;
    const shelf = document.querySelector('#update-shelf').value;
    const imageInput = document.querySelector('#update-image');
    const pdfInput = document.querySelector('#update-pdf'); // New field for PDF upload

    if (!title || !author || !genre || !copies || !rack || !shelf) {
        alert('Please fill in all fields.');
        return;
    }

    const formData = new FormData();
    formData.append('title', title);
    formData.append('author', author);
    formData.append('genre', genre);
    formData.append('copies', copies);
    formData.append('rack', rack);
    formData.append('shelf', shelf);
    if (imageInput.files.length > 0) {
        formData.append('image', imageInput.files[0]);
    }
    if (pdfInput.files.length > 0) {
        formData.append('pdf', pdfInput.files[0]);
    }

    fetch(`/api/books/${bookId}`, {
        method: 'PUT',
        body: formData,
    })
        .then(response => {
            if (response.ok) {
                alert('Book updated successfully!');
                fetchBooks(); // Reload books to reflect changes
                document.querySelector('#update-book-form').reset();
                document.querySelector('#update-book-form').style.display = 'none';
            } else {
                throw new Error('Failed to update the book.');
            }
        })
        .catch(err => {
            console.error('Error updating book:', err);
            alert('Failed to update the book. Please try again.');
        });
}

//handle delete book
function deleteBook(bookId) {
  if (confirm('Are you sure you want to delete this book?')) {
    fetch(`/api/books/${bookId}`, {
      method: 'DELETE',
    })
      .then(response => {
        if (response.ok) {
          return response.text();
        } else {
          throw new Error('Failed to delete the book.');
        }
      })
      .then(() => {
        alert('Book deleted successfully!');
        fetchBooks();
      })
      .catch(err => {
        console.error('Error deleting book:', err);
        alert('Failed to delete the book. Please try again.');
      });
  }
}

// Initialize the page by fetching the books
fetchBooks();


const modal = document.getElementById('modal');
const openModal = document.getElementById('open-modal');
const closeModal = document.querySelector('.close-button');

// Open modal when anchor tag is clicked
openModal.addEventListener('click', (event) => {
    event.preventDefault(); // Prevent default anchor behavior
    modal.style.display = 'block'; // Show modal
});

// Close modal when close button is clicked
closeModal.addEventListener('click', () => {
    modal.style.display = 'none'; // Hide modal
});

// Close modal when clicking outside modal content
window.addEventListener('click', (event) => {
    if (event.target === modal) {
        modal.style.display = 'none'; // Hide modal
    }
});

// Handle form submission
// Handle form submission for returning a book
document.getElementById('return-form').addEventListener('submit', async (event) => {
    event.preventDefault();

    const studentName = document.getElementById('student-name').value; // Student Name
    const bookTitle = document.getElementById('book-title').value; // Book Title
    const returnDate = document.getElementById('return-date').value; // Return Date

    // Prepare data to send to the server
    const data = {
        borrower_name: studentName, // Ensure this matches the backend field name
        book_title: bookTitle,      // Ensure this matches the backend field name
        return_date: returnDate
    };

    try {
        const response = await fetch('/api/return', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await response.json();

        if (result.message) {
            alert(result.message);
            modal.style.display = 'none'; // Close modal after successful return
        } else {
            alert('An error occurred: ' + result.error);
        }
    } catch (error) {
        console.error('Error returning the book:', error);
        alert('Failed to return the book.');
    }
});


function searchBooks(event) {
    event.preventDefault();
  
    const title = document.querySelector('#title').value.toLowerCase();
    const author = document.querySelector('#name').value.toLowerCase();
    const genre = document.querySelector('#Genre').value.toLowerCase();
    const selectOption = document.querySelector('#select-option1').value;
  
    let filteredBooks = books.filter(book => {
      let match = true;
      if (selectOption === 'All' || selectOption === 'Title') {
        if (!book.title.toLowerCase().includes(title)) match = false;
      }
      if (selectOption === 'All' || selectOption === 'Author') {
        if (!book.author.toLowerCase().includes(author)) match = false;
      }
      if (selectOption === 'All' || selectOption === 'Genre') {
        if (!book.genre.toLowerCase().includes(genre)) match = false;
      }
      return match;
    });
  
    if (filteredBooks.length === 0) {
      alert('No books available matching your search criteria.');
    } else {
      displayBooks(filteredBooks);
    }
  }
  



  </script>

  


</body>
</html>